{% extends "home/base.html" %}
{% load static %}
{% load custom_filters %}

{% block addon_css %}
    <!-- Existing CSS links and styles -->
    <link href="{% static 'home/css/sequenceviewer.css' %}" rel="stylesheet">
    <link href="{% static 'home/css/color_picker.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'home/css/jquery.dataTables.min.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/construct_browser.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/yadcf_bootstrap_version.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/select2.css' %}" type="text/css" />
    <link href="{% static 'home/css/construct_alignment.css' %}" rel="stylesheet">
    <link href="{% static 'home/css/sequenceviewer.css' %}" rel="stylesheet">
    <link href="{% static 'home/css/modal.css' %}" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{% static 'home/css/jquery.powertip.css' %}" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }

        #Viewer {
            width: 600px;
            height: 500px;
            position: relative;
            overflow: hidden;
        }
        .scrollable-table {
            overflow-x: auto;
            white-space: nowrap;
            position: relative;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            table-layout: auto; /* Allow columns to adjust based on content */
        }
        th, td {
            padding: 10px; /* Increased padding for better readability */
            text-align: center;
        }
        th {
            background-color: white;
        }
        .segment-header {
            background-color: white;
            text-align: center;
            font-weight: bold;
            padding: 10px;
        }
        .residue {
            text-align: center;
            padding: 10px;
        }
        .res-color-A, .res-color-M, .res-color-V, .res-color-L, .res-color-I { background-color: yellow; }
        .res-color-R, .res-color-K { background-color: blue; color: white; }
        .res-color-D, .res-color-E { background-color: red; color: white; }
        .res-color-N, .res-color-Q, .res-color-S, .res-color-T { background-color: darkviolet; color: white; }
        .res-color-W { background-color: green; }
        .res-color-Y, .res-color-F { background-color: springgreen; }
        .res-color-P { background-color: lightcoral; color: white; }
        .res-color-G { background-color: plum; }
        .res-color-H { background-color: dodgerblue; }
        .res-color-C { background-color: goldenrod; }
        .mutation { color: red; text-align: center; font-size: 150%; font-weight: bold; }
        .fixed-column {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 1;
        }
        .fixed-column th, .fixed-column td {
            background-color: white;
        }
        .data-row.N {
            background-color: #e0f7fa;
        }
        .data-row.C {
            background-color: #ffe0b2;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container">

    <!-- Page Heading -->
    <h1 class="detail_title text-center">                
        {% if not structure.pdb_code %}
        AlphaFold model {{ structure.protein.accession }}-AF
        {% else %}
        PDB structure <a href="https://www.rcsb.org/structure/{{ structure.pdb_code.index }}" target="_blank">{{ structure.pdb_code.index }}</a>
        {% endif %}
        {% if chain %}
        - chain {{ chain.chain_ID }}
        {% endif %}
    </h1>
    <br>

    <!-- Main Content -->
    <div class="row">

        <!-- Structure details -->
        <div class="col-md-6">
            <h3 id="structure_details">Structure details</h3>
            <hr class="my-2">
            <div class="row">
                <div class="col-12">
                    <ul class="list-unstyled">
                        <li><b>Protein:</b>
                            {{protein}} <a href="/protein/{{protein}}"><span class="material-symbols-outlined">open_in_new</span></a>
                        </li>
                        <li><b>Organism:</b> 
                            <i>{{ protein.species }}</i>
                        </li>
                        <li><b>UniProt ID:</b> 
                            {{ protein.accession }} <a href="https://www.uniprot.org/uniprot/{{ protein.accession }}" target="_blank" title="www.uniprot.org">
                            <span class="material-symbols-outlined">open_in_new</span></a>
                        </li>
                    </ul>

                    <ul class="list-unstyled">
                        <li><b>Method:</b> <a>{{ structure.structure_type.name }}</a></li>
                        <li><b>Resolution:</b> {% if structure.resolution != None %}<a>{{ structure.resolution }} Ã…</a>{% endif %}</li>
                        <li><b>Date:</b> <a>{{ structure.publication_date }}</a></li>
                        <li><b>Reference:</b> {{ structure.publication.web_link.index }}
                                <a href="https://doi.org/{{ structure.publication.web_link.index }}" target="_blank"><span class="material-symbols-outlined">open_in_new</span></a></li>
                        <li><b>State:</b> <a>{{ structure.state }}</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 3D view -->
        <div class="col-md-6">
            <h3 id="3d_view">3D view</h3>
            <hr class="my-2">
            <div class="row justify-content-center">
                <div>
                    <div id="viewport" style="width:500px; height:400px;"></div>
                    <div style="width:500px; background-color:#eaeaea; border-radius: 0px 0px 5px 5px;">
                        <p style="padding: 2px 0px 2px 5px; font-size: 10px;"><button id="fullscreen">Full Screen</button><a href="https://github.com/arose/ngl" target='_blank'> NGL</a> is a WebGL based 3D viewer powered by <a href="https://mmtf.rcsb.org" target='_blank'>MMTF</a>.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <br>

    <div id='table_container' style='padding-top: 0px; font-size: 12px; white-space: nowrap; width:100%; display:inline-block; overflow: auto;'>
        <button id="download_csv" style="margin-bottom: 10px;">Download alignment</button>
        <div id='scroll_body'>
            <table id="alignment_table" class="display compact" style="display:table;">
    
                <thead id="table_header">
                    <tr> <!-- column headers -->
                        <th class='white-bg fixed_column1' style='text-align:center;'>Segment</th>
                        {% for gn, protein_residue, structure_rotamers in aligned_sequences %}
                            <th class='white-bg fixed_column1' style='text-align:center;'>{{ gn }}</th>
                        {% endfor %}
                    </tr>
                </thead>
    
                <tbody id="alignment_table_body">
                    <tr class="data-row">
                        <td class="fixed-column">UniProt Sequence</td>
                        {% for gn, protein_residue, structure_rotamers in aligned_sequences %}
                            <td class="fixed-column2 {% if protein_residue %}res-color-{{ protein_residue.amino_acid }}{% else %}empty{% endif %}" title="{% if protein_residue %}{{ protein_residue.tooltip }}{% else %}No Data{% endif %}">{% if protein_residue %}{{ protein_residue.amino_acid }}{% else %}-{% endif %}</td>
                        {% endfor %}
                    </tr>
                    {% for chain in chains %}
                        <tr class="data-row">
                            <td class="fixed-column">Structure Sequence (Chain {{ chain }})</td>
                            {% for gn, protein_residue, structure_rotamers in aligned_sequences %}
                                {% if structure_rotamers %}
                                    {% with rotamer=structure_rotamers|get_item:chain %}
                                        <td class="fixed-column3 {% if rotamer %}res-color-{{ rotamer.amino_acid }}{% else %}empty{% endif %}" title="{% if rotamer %}{{ rotamer.tooltip }}{% else %}No Data{% endif %}">{% if rotamer %}{{ rotamer.amino_acid }}{% else %}-{% endif %}</td>
                                    {% endwith %}
                                {% else %}
                                    <td class="fixed-column3 empty" title="No Data">-</td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                    {% endfor %}
                    <tr class="data-row">
                        <td class="fixed-column">Mutation</td>
                        {% for gn, protein_residue, structure_rotamers in aligned_sequences %}
                            {% for chain in chains %}
                                {% if structure_rotamers %}
                                    {% with rotamer=structure_rotamers|get_item:chain %}
                                        <td class="fixed-column4" style="font-size: 20px; text-align:center; color: red;" title="{% if rotamer and rotamer.residue_type == 'mutated' %}Mutated{% else %}No Mutation{% endif %}">
                                            {% if rotamer and rotamer.residue_type == 'mutated' %}
                                                *
                                            {% endif %}
                                        </td>
                                    {% endwith %}
                                {% else %}
                                    <td class="fixed-column4 empty" title="No Data"></td>
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="d-flex flex-column flex-md-row p-4 gap-4 py-md-5 align-items-center justify-content-center">
        <div class="list-group">
          <a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3" aria-current="true">
            <img src="https://github.com/twbs.png" alt="twbs" width="32" height="32" class="rounded-circle flex-shrink-0">
            <div class="d-flex gap-2 w-100 justify-content-between">
              <div>
                <h6 class="mb-0">List group item heading</h6>
                <p class="mb-0 opacity-75">Some placeholder content in a paragraph.</p>
              </div>
              <small class="opacity-50 text-nowrap">now</small>
            </div>
          </a>
          <a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3" aria-current="true">
            <img src="https://github.com/twbs.png" alt="twbs" width="32" height="32" class="rounded-circle flex-shrink-0">
            <div class="d-flex gap-2 w-100 justify-content-between">
              <div>
                <h6 class="mb-0">Another title here</h6>
                <p class="mb-0 opacity-75">Some placeholder content in a paragraph that goes a little longer so it wraps to a new line.</p>
              </div>
              <small class="opacity-50 text-nowrap">3d</small>
            </div>
          </a>
          <a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3" aria-current="true">
            <img src="https://github.com/twbs.png" alt="twbs" width="32" height="32" class="rounded-circle flex-shrink-0">
            <div class="d-flex gap-2 w-100 justify-content-between">
              <div>
                <h6 class="mb-0">Third heading</h6>
                <p class="mb-0 opacity-75">Some placeholder content in a paragraph.</p>
              </div>
              <small class="opacity-50 text-nowrap">1w</small>
            </div>
          </a>
        </div>
      </div>

      <br>

    <!-- Entity information -->
    <div class="col-md-12"> 
        <div class="container mt-5">
            <h3>Structure Entities</h3>
            <hr class="my-2">
            {% for type in entity_types %}
                <h3>{{ type.name }}</h3>
                <div class="row">
                    {% for entity in type.filtered_entities %}
                        <div class="col-md-4 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">{{ entity.name }} ({{ entity.chain }})</h5>
                                    <p class="card-text">Organism: {{ entity.organism }}</p>
                                    <p class="card-text">UNP Accession: {{ entity.unp_accession }}</p>
                                    <p class="card-text">PFAM Accession: {{ entity.pfam_accession }}</p>
                                    <p class="card-text">Entity Type: {{ type.name }}</p>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="col-12">
                            <p>No entities found for this type.</p>
                        </div>
                    {% endfor %}
                </div>
            {% empty %}
                <p>No entity types found.</p>
            {% endfor %}
        </div>

        <div>
            {% if interactions %}
            <div class="row">
                <div class="col-md-3 text-right text-info">
                    <h4>Chemokine interactions:</h4>
                </div>
                <div class="col-md-9">
                    {% for chain_id, url in interaction_urls.items %}
                        <a href="{{ url }}">{{ interactions_count|default_if_none:0|get_item:chain_id }} interactions for chain {{ chain_id }} (Click to see)</a><br>
                    {% endfor %}
                </div>
            </div>
            {% else %}
                <a>No interactions found for this structure</a>
            {% endif %}
        </div>
        
    <br>

    <!-- Snake plot -->
    <div class="row">
        <div class="col-md-12">
            <h3 id="snake_plot">Snake Plot</h3>
            <hr class="my-2">
            {{ protein }}
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <span class="glyphicon glyphicon-download"></span> Download <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                    <li>
                        <a href="javascript:saveSvgAsPng(document.getElementById('snakeplot'), 'snake_{{ p.entry_name }}.png', {scale: 3});">PNG</a>
                    </li>
                    <li>
                        <a href="javascript:saveSvgAsJpg(document.getElementById('snakeplot'), 'snake_{{ p.entry_name }}.jpg', {scale: 3});">JPG</a>
                    </li>
                    <li>
                        <a href="javascript:saveSvgAsTiff(document.getElementById('snakeplot'), 'snake_{{ p.entry_name }}.tiff', {scale: 3});">TIFF</a>
                    </li>
                    <li>
                        <a id=snake_svg_link href-lang="image/svg+xml" href="" download="snake_{{ p.entry_name }}">SVG</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <br>
    <br>
    <div>
        {{ distmatrix|safe }}
    </div>
    <div>
        {{ chart|safe }}
    </div>     

    <script>
        $( document ).ready(function() {
            y_min = 0;
            y_max = 0;
            $('rect').each(function(){
                rectclass = $(this).attr('class');
                if (rectclass) {
                    if (rectclass.indexOf("CL") >= 0 && rectclass.indexOf("long") >= 0) {
                        numResidues = ($('.'+rectclass.replace(/ /g,".")).length-3)/2
                        if (numResidues<10) {
                            toggleLoop('.'+rectclass.split(' ')[0],'',1);
                        }
                    }
                }
            });
            maxmin();
            $("text").tooltip({
                'container': 'body',
                'placement': 'top',
                'animation': false,
                'html' : true
            });
            $("circle").tooltip({
                'container': 'body',
                'placement': 'top',
                'animation': false,
                'html' : true
            });
            $("circle").hover(function(){
                $('.tooltip').css('top',parseInt($('.tooltip').css('top')) + 2.8 + 'px')
            });
        
            $(".rtext").click(function() {
                parentid = $(this).closest('svg').attr('id');
                newcolor = $(".pick-color."+parentid+".selected").attr('id');
                if (newcolor) {
                  newcolor = newcolor.split('-');
                } else {
                  custom =  $("#custom_color_"+parentid).val();
                  custom_text = getContrast50(custom);
                  newcolor = ["pick",custom,custom_text];
                }
              console.log(newcolor);
            
              $(this).css("fill", newcolor[2]);
              $(this).prev().css("fill", newcolor[1]);
            });

            $(".rcircle").click(function() {
                parentid = $(this).closest('svg').attr('id');
                newcolor = $(".pick-color."+parentid+".selected").attr('id');
                if (newcolor) {
                  newcolor = newcolor.split('-');
                } else {
                  custom =  $("#custom_color_"+parentid).val();
                  custom_text = getContrast50(custom);
                  newcolor = ["pick",custom,custom_text];
                }
              console.log(newcolor);
              $(this).css("fill", newcolor[1]);
              $(this).next().css("fill", newcolor[2]);
            });

            $("#snake_svg_link").click(function() {
                svgAsDataUri(document.getElementById("snakeplot"),{}, function(uri) {
                    $("#snake_svg_link").attr('href',uri);
                });
            });
            $("#helix_svg_link").click(function() {
                svgAsDataUri(document.getElementById("helixbox"),{}, function(uri) {
                    $("#helix_svg_link").attr('href',uri);
                });
            });

        });

        $(".pick-color").click(function() {
            plottype = $(this).attr('class').split(' ')[1];
        
            console.log($(this).attr('id'));
            $(".pick-color."+plottype).css('borderWidth','2px');
            $(".pick-color."+plottype).css('height','20px');
            $(".pick-color."+plottype).removeClass('selected');
            $(this).css('borderWidth','3px');
            $(this).css('height','22px');
            $(this).addClass('selected');
        
        });
    </script>
{% endblock %}

{% block addon_js %}
<script src="{% static 'home/js/ngl.js' %}"></script>
<script src="{% static 'home/js/table_functions.js' %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var stage_full;
        var stage = new NGL.Stage("viewport", { backgroundColor: "white" } );
        console.log('here 1')
        var stringBlob = new Blob( [ `'{{structure.pdb_data.pdb}}'` ], { type: 'text/plain'} );
        var file = new File([stringBlob], "something.pdb");
        $('[data-toggle="tooltip"]').tooltip();

        stage.loadFile( file, { defaultRepresentation: true } );

        $( "#fullscreen" ).click(function() {
            stage.toggleFullscreen();
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('download_csv').addEventListener('click', function () {
            var table = document.getElementById('alignment_table');
            var rows = Array.from(table.rows);
            var csvContent = '';
    
            rows.forEach(function(row) {
                var cols = Array.from(row.cells);
                var rowData = cols.map(function(cell) {
                    return cell.innerText.replace(/,/g, ''); // Remove commas to prevent CSV issues
                }).join(',');
                csvContent += rowData + '\r\n'; // Use \r\n for new line
            });
    
            var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            if (link.download !== undefined) {
                var url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'table_data.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });
    });
</script>

<script src="{% static 'home/js/sequenceviewer.js' %}"></script>
<script src="{% static 'home/js/saveSvgAsPng.js' %}"></script>
<script src="{% static 'home/js/diagrams.js' %}"></script>
<script src="{% static 'home/js/color_picker.js' %}"></script>
<script src="{% static 'home/js/jquery.dataTables.min.js' %}"> </script>
<script src="{% static 'home/js/jquery.dataTables.yadcf.js' %}"> </script>
<script src="{% static 'home/js/select2.js' %}"> </script>
<script src="{% static 'home/js/alignment.js' %}"> </script>
<script src="{% static 'home/js/jquery.powertip.js' %}"></script>
{% endblock %}
